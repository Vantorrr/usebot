<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>USEbot Admin</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .header h1 {
      color: white;
      font-size: 2.5rem;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      margin-bottom: 8px;
    }
    
    .header p {
      color: rgba(255,255,255,0.9);
      font-size: 1.1rem;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .full-width {
      grid-column: 1 / -1;
    }
    
    .card {
      background: white;
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      min-height: 200px;
      display: flex;
      flex-direction: column;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    }
    
    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.12);
    }
    
    .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .card h2 {
      color: #2d3748;
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f7fafc;
    }
    
    .card h3 {
      color: #4a5568;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 16px 0 8px 0;
    }
    
    .icon {
      width: 24px;
      height: 24px;
      opacity: 0.8;
    }
    
    input, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background: #f8fafc;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: white;
    }
    
    textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: auto;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    button:hover::before {
      left: 100%;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    button:active {
      transform: translateY(-1px);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .stat-item {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px 20px;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      transition: transform 0.3s ease;
    }
    
    .stat-item:hover {
      transform: translateY(-4px);
    }
    
    .stat-item:nth-child(2) {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
    }
    
    .stat-item:nth-child(3) {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    
    th {
      background: #f8fafc;
      font-weight: 600;
      color: #4a5568;
    }
    
    .form-row {
      display: flex;
      gap: 12px;
      align-items: end;
      margin-bottom: 16px;
    }
    
    .form-row input {
      margin-top: 0;
    }
    
    .form-row button {
      margin-top: 0;
      white-space: nowrap;
    }
    
    .empty-state {
      text-align: center;
      color: #718096;
      font-style: italic;
      padding: 32px;
    }
    
    @media (max-width: 1200px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .grid, .grid-2 {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .card {
        min-height: auto;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🤖 USEbot Admin</h1>
      <p>Управление продающим ботом от девушки</p>
    </div>
    <div id="root"></div>
  </div>
  <script>
    const e = React.createElement;

    function useFetch(url, deps) {
      const [data, setData] = React.useState(null);
      React.useEffect(() => {
        fetch(url).then(r => r.json()).then(setData).catch(() => setData(null));
      }, deps);
      return [data, setData];
    }

    function PromptCard() {
      const [data, setData] = useFetch('/api/settings/prompt', []);
      const [value, setValue] = React.useState('');
      React.useEffect(() => { if (data && data.prompt !== undefined) setValue(data.prompt); }, [data]);
      const save = async () => {
        await fetch('/api/settings/prompt', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt: value })});
        alert('✅ Промт сохранён!');
      };
      return e('div', { className: 'card' }, [
        e('div', { key: 'content', className: 'card-content' }, [
          e('h2', { key: 'h2' }, ['🧠 Промт для LLM']),
          e('textarea', { key: 'ta', value, onChange: e => setValue(e.target.value), placeholder: 'Введите системный промт для бота...', style: { flex: 1 } }),
          e('button', { key: 'btn', onClick: save }, '💾 Сохранить промт')
        ])
      ]);
    }

    function Scenarios() {
      const [list, setList] = useFetch('/api/scenarios', []);
      const [name, setName] = React.useState('');
      const create = async () => {
        const r = await fetch('/api/scenarios', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name })});
        if (r.ok) { setName(''); fetch('/api/scenarios').then(r => r.json()).then(setList); }
      };
      return e('div', { className: 'card' }, [
        e('h2', { key: 'h2' }, ['📝 Сценарии воронки']),
        e('div', { key: 'form', className: 'form-row' }, [
          e('input', { placeholder: 'Название нового сценария', value: name, onChange: e => setName(e.target.value) }),
          e('button', { onClick: create }, '➕ Создать')
        ]),
        (list && list.length > 0) ? 
          e('table', { key: 'table' }, [
            e('thead', {}, e('tr', {}, [e('th', {}, 'Название'), e('th', {}, 'Статус')])),
            e('tbody', {}, list.map(s => e('tr', { key: s.id }, [e('td', {}, s.name), e('td', {}, s.is_active ? '✅ Активен' : '❌ Неактивен')])))
          ]) :
          e('div', { key: 'empty', className: 'empty-state' }, '📋 Пока нет сценариев')
      ]);
    }

    function CtaCard() {
      const [data] = useFetch('/api/settings/cta', []);
      const [value, setValue] = React.useState('');
      React.useEffect(() => { if (data && data.cta !== undefined) setValue(data.cta); }, [data]);
      const save = async () => {
        await fetch('/api/settings/cta', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ cta: value })});
        alert('🔗 CTA ссылка сохранена!');
      };
      return e('div', { className: 'card' }, [
        e('h2', { key: 'h2' }, ['🎯 CTA ссылка']),
        e('input', { key: 'inp', value, onChange: e => setValue(e.target.value), placeholder: 'https://networkassistant.ai/register?invite_code=...' }),
        e('button', { key: 'btn', onClick: save }, '🔗 Сохранить ссылку')
      ]);
    }

    function KeywordsCard() {
      const [data, setData] = useFetch('/api/settings/keywords', []);
      const [value, setValue] = React.useState('');
      React.useEffect(() => { if (data && data.keywords !== undefined) setValue(data.keywords); }, [data]);
      const save = async () => {
        await fetch('/api/settings/keywords', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ keywords: value })});
        alert('🔍 Ключевые слова сохранены!');
      };
      return e('div', { className: 'card' }, [
        e('h2', { key: 'h2' }, ['🔍 Ключевые слова']),
        e('textarea', { key: 'ta', value, onChange: e => setValue(e.target.value), placeholder: 'знакомства,отношения,пара,любовь,встречи...' }),
        e('div', { key: 'help', style: { fontSize: '12px', color: '#666', marginTop: '8px' } }, 'Через запятую. Бот будет искать людей, которые пишут эти слова в чатах.'),
        e('button', { key: 'btn', onClick: save }, '🔍 Сохранить слова')
      ]);
    }

    function ChatsCard() {
      const [data, setData] = useFetch('/api/settings/chats', []);
      const [value, setValue] = React.useState('');
      React.useEffect(() => { if (data && data.chats !== undefined) setValue(data.chats); }, [data]);
      const save = async () => {
        await fetch('/api/settings/chats', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chats: value })});
        alert('💬 Чаты сохранены!');
      };
      return e('div', { className: 'card' }, [
        e('h2', { key: 'h2' }, ['💬 Целевые чаты']),
        e('textarea', { key: 'ta', value, onChange: e => setValue(e.target.value), placeholder: '@chat1,@chat2,-1001234567890...' }),
        e('div', { key: 'help', style: { fontSize: '12px', color: '#666', marginTop: '8px' } }, 'Через запятую. Юзернеймы (@chat) или ID (-100...). Бот будет слушать эти чаты и постить туда.'),
        e('button', { key: 'btn', onClick: save }, '💬 Сохранить чаты')
      ]);
    }

    function LimitsCard() {
      const [data, setData] = useFetch('/api/settings/limits', []);
      const [dmLimit, setDmLimit] = React.useState('7');
      const [postsLimit, setPostsLimit] = React.useState('3');
      const [llmOn, setLlmOn] = React.useState(true);
      React.useEffect(() => { 
        if (data) {
          if (data.daily_dm_limit !== undefined) setDmLimit(data.daily_dm_limit);
          if (data.chat_posts_per_day !== undefined) setPostsLimit(data.chat_posts_per_day);
        }
      }, [data]);
      const save = async () => {
        await fetch('/api/settings/limits', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ 
          daily_dm_limit: parseInt(dmLimit), 
          chat_posts_per_day: parseInt(postsLimit) 
        })});
        alert('⚡ Лимиты сохранены!');
      };
      return e('div', { className: 'card' }, [
        e('h2', { key: 'h2' }, ['⚡ Лимиты безопасности']),
        e('div', { key: 'dm-row', className: 'form-row' }, [
          e('div', { style: { flex: 1 } }, [
            e('label', { style: { display: 'block', marginBottom: '4px', fontSize: '14px', fontWeight: '500' } }, 'ЛС в день:'),
            e('input', { type: 'number', value: dmLimit, onChange: e => setDmLimit(e.target.value), min: '1', max: '20' })
          ])
        ]),
        e('div', { key: 'posts-row', className: 'form-row' }, [
          e('div', { style: { flex: 1 } }, [
            e('label', { style: { display: 'block', marginBottom: '4px', fontSize: '14px', fontWeight: '500' } }, 'Постов в день:'),
            e('input', { type: 'number', value: postsLimit, onChange: e => setPostsLimit(e.target.value), min: '1', max: '10' })
          ])
        ]),
        e('div', { key: 'llm', className: 'form-row' }, [
          e('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } }, [
            e('input', { type: 'checkbox', checked: llmOn, onChange: e => setLlmOn(e.target.checked) }),
            e('span', {}, 'Включить LLM для прогрева (стадии 1–2)')
          ])
        ]),
        e('button', { key: 'btn', onClick: save }, '⚡ Сохранить лимиты')
      ]);
    }

    function TargetUsersCard() {
      const [users] = useFetch('/api/target-users', []);
      return e('div', { className: 'card' }, [
        e('h2', { key: 'h2' }, ['👥 Найденные пользователи']),
        users && users.length > 0 ? 
          e('table', { key: 'table' }, [
            e('thead', {}, e('tr', {}, [
              e('th', {}, 'Имя'), 
              e('th', {}, 'Чат'), 
              e('th', {}, 'Слово'), 
              e('th', {}, 'Статус')
            ])),
            e('tbody', {}, users.slice(0, 10).map(u => e('tr', { key: u.user_id }, [
              e('td', {}, u.first_name || u.username || u.user_id), 
              e('td', {}, u.found_in_chat), 
              e('td', {}, u.keyword_matched),
              e('td', {}, u.status === 'found' ? '🔍 Найден' : u.status === 'contacted' ? '💌 Написано' : '✅ Ответил')
            ])))
          ]) :
          e('div', { key: 'empty', className: 'empty-state' }, '🔍 Пока никого не найдено')
      ]);
    }

    function Stats() {
      const [stats] = useFetch('/api/stats', []);
      if (!stats) return e('div', { className: 'card' }, [e('h2', {}, '📊 Аналитика'), e('div', {}, '⏳ Загрузка...')]);
      
      return e('div', { className: 'card' }, [
        e('h2', { key: 'h2' }, ['📊 Аналитика']),
        e('div', { key: 'stats-grid', className: 'stats-grid' }, [
          e('div', { key: 'dialogs', className: 'stat-item' }, [
            e('div', { className: 'stat-number' }, stats.dialogs || 0),
            e('div', { className: 'stat-label' }, 'Диалогов')
          ]),
          e('div', { key: 'events', className: 'stat-item' }, [
            e('div', { className: 'stat-number' }, stats.events || 0),
            e('div', { className: 'stat-label' }, 'Событий')
          ]),
          e('div', { key: 'conversions', className: 'stat-item' }, [
            e('div', { className: 'stat-number' }, stats.conversions || 0),
            e('div', { className: 'stat-label' }, 'Конверсий')
          ])
        ]),
        e('h3', { key: 'h3' }, '🎯 Конверсии по этапам'),
        e('div', { key: 'stages' }, (stats.conversionsByStage || []).length > 0 ? 
          (stats.conversionsByStage || []).map(s => `Этап ${s.stage}: ${s.count}`).join(' • ') : 
          '📈 Данных пока нет'
        )
      ]);
    }

    function App() {
      return e(React.Fragment, null, [
        // Основные настройки - 3 колонки
        e('div', { key: 'main-grid', className: 'grid' }, [
          e(PromptCard, { key: 'p' }),
          e(CtaCard, { key: 'c' }),
          e(KeywordsCard, { key: 'k' })
        ]),
        
        // Чаты и лимиты - 2 колонки
        e('div', { key: 'config-grid', className: 'grid-2' }, [
          e(ChatsCard, { key: 'ch' }),
          e(LimitsCard, { key: 'l' })
        ]),
        
        // Пользователи и аналитика - 2 колонки
        e('div', { key: 'analytics-grid', className: 'grid-2' }, [
          e(TargetUsersCard, { key: 'tu' }),
          e(Stats, { key: 'st' })
        ])
      ]);
    }

    ReactDOM.createRoot(document.getElementById('root')).render(e(App));
  </script>
</body>
</html>


